<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substack Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a2e;
            color: #e4e4e7;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #16213e;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        h1 {
            color: #00d4ff;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            color: #a1a1aa;
            font-size: 14px;
        }

        input, select {
            background: #0f3460;
            border: 1px solid #2d4059;
            color: #e4e4e7;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #00b8e6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a1a1aa;
        }

        .spinner {
            border: 3px solid #2d4059;
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .category-section {
            margin-bottom: 40px;
        }

        .category-header {
            background: #16213e;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-title {
            color: #00d4ff;
            font-size: 18px;
            font-weight: 600;
        }

        .category-count {
            color: #a1a1aa;
            font-size: 14px;
        }

        .posts-grid {
            display: grid;
            gap: 20px;
        }

        .post-card {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.1);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
            gap: 15px;
        }

        .post-meta {
            flex: 1;
        }

        .publication {
            color: #00d4ff;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .author {
            color: #a1a1aa;
            font-size: 13px;
        }

        .post-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #71717a;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .post-title {
            font-size: 20px;
            font-weight: 600;
            color: #e4e4e7;
            margin: 12px 0;
            line-height: 1.3;
        }

        .post-title a {
            color: #e4e4e7;
            text-decoration: none;
        }

        .post-title a:hover {
            color: #00d4ff;
        }

        .post-excerpt {
            color: #a1a1aa;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #2d4059;
        }

        .date-info {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #71717a;
        }

        .reading-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
        }

        .word-count {
            color: #a1a1aa;
        }

        .read-time {
            color: #00d4ff;
            font-weight: 500;
        }

        .no-posts {
            text-align: center;
            padding: 60px 20px;
            color: #71717a;
        }

        .error {
            background: #991b1b;
            color: #fecaca;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Substack Reader</h1>
            <div class="controls">
                <div class="filter-group">
                    <label>Min Words:</label>
                    <input type="number" id="minWords" value="0" min="0" step="100">
                </div>
                <div class="filter-group">
                    <label>Min Read Time:</label>
                    <input type="number" id="minReadTime" value="0" min="0" step="1">
                    <span style="color: #a1a1aa; font-size: 14px;">min</span>
                </div>
                <div class="filter-group">
                    <label>Sort By:</label>
                    <select id="sortBy">
                        <option value="date">Date (Newest)</option>
                        <option value="date-old">Date (Oldest)</option>
                        <option value="length">Length (Longest)</option>
                        <option value="publication">Publication</option>
                    </select>
                </div>
                <button onclick="applyFilters()">Apply Filters</button>
                <button onclick="loadFeeds()">Refresh</button>
            </div>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div id="loadingText">Loading feeds...</div>
        </div>

        <div id="error" style="display: none;"></div>
        <div id="content"></div>
    </div>

    <script>
        let allPosts = [];
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

        async function loadFeeds() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').innerHTML = '';
            document.getElementById('error').style.display = 'none';
            allPosts = [];

            try {
                const response = await fetch('library.json');
                const feeds = await response.json();
                
                let loaded = 0;
                const total = feeds.length;

                await Promise.all(
                    feeds.map(async (feedUrl) => {
                        try {
                            await loadFeed(feedUrl);
                        } catch (err) {
                            console.error(`Failed to load ${feedUrl}:`, err);
                        } finally {
                            loaded++;
                            document.getElementById('loadingText').textContent = 
                                `Loading feeds... ${loaded}/${total}`;
                        }
                    })
                );

                document.getElementById('loading').style.display = 'none';
                applyFilters();
            } catch (err) {
                showError('Failed to load library.json: ' + err.message);
            }
        }

        async function loadFeed(feedUrl) {
            const response = await fetch(CORS_PROXY + encodeURIComponent(feedUrl));
            const text = await response.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'text/xml');

            const isAtom = xml.querySelector('feed');
            const channel = isAtom ? xml.querySelector('feed') : xml.querySelector('channel');
            
            const publicationName = getTextContent(channel, isAtom ? 'title' : 'title');
            const publicationUrl = isAtom ? 
                channel.querySelector('link[rel="alternate"]')?.getAttribute('href') :
                getTextContent(channel, 'link');

            const items = isAtom ? 
                Array.from(xml.querySelectorAll('entry')) :
                Array.from(xml.querySelectorAll('item'));

            for (const item of items) {
                try {
                    const post = parsePost(item, isAtom, publicationName, publicationUrl, feedUrl);
                    if (post && post.isTextPost) {
                        allPosts.push(post);
                    }
                } catch (err) {
                    console.error('Failed to parse post:', err);
                }
            }
        }

        function parsePost(item, isAtom, publicationName, publicationUrl, feedUrl) {
            const title = getTextContent(item, 'title');
            const link = isAtom ? 
                item.querySelector('link[rel="alternate"]')?.getAttribute('href') :
                getTextContent(item, 'link');
            
            const content = getTextContent(item, 'content:encoded') || 
                           getTextContent(item, 'content') ||
                           getTextContent(item, 'description') ||
                           getTextContent(item, 'summary');

            // Skip if video or audio
            const contentLower = (content || '').toLowerCase();
            if (contentLower.includes('<video') || contentLower.includes('<audio') ||
                contentLower.includes('type="video') || contentLower.includes('type="audio')) {
                return null;
            }

            const author = getTextContent(item, 'author name') ||
                          getTextContent(item, 'dc:creator') ||
                          getTextContent(item, 'author') ||
                          'Unknown Author';

            const dateStr = getTextContent(item, 'published') ||
                           getTextContent(item, 'pubDate') ||
                           getTextContent(item, 'updated');
            const date = new Date(dateStr);

            const textContent = stripHtml(content);
            const wordCount = countWords(textContent);
            const readTime = Math.ceil(wordCount / 200); // 200 words per minute

            return {
                title,
                link,
                content: textContent.substring(0, 300),
                author,
                publicationName,
                publicationUrl,
                feedUrl,
                date,
                wordCount,
                readTime,
                isTextPost: true
            };
        }

        function getTextContent(element, selector) {
            const el = element.querySelector(selector);
            return el ? el.textContent.trim() : '';
        }

        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        function countWords(text) {
            return text.trim().split(/\s+/).filter(w => w.length > 0).length;
        }

        function categorize(posts) {
            const sorted = [...posts].sort((a, b) => b.date - a.date);
            const categories = {
                'Fresh & Recent': [],
                'Deep Dives': [],
                'Quick Reads': [],
                'Archive Gems': []
            };

            const now = new Date();
            const dayMs = 24 * 60 * 60 * 1000;

            for (const post of sorted) {
                const ageInDays = (now - post.date) / dayMs;
                
                if (ageInDays <= 7) {
                    categories['Fresh & Recent'].push(post);
                } else if (post.readTime >= 15) {
                    categories['Deep Dives'].push(post);
                } else if (post.readTime <= 5) {
                    categories['Quick Reads'].push(post);
                } else {
                    categories['Archive Gems'].push(post);
                }
            }

            // Redistribute if categories are too uneven
            const total = posts.length;
            const target = Math.ceil(total / 4);
            
            Object.keys(categories).forEach(cat => {
                while (categories[cat].length > target * 1.5) {
                    const post = categories[cat].pop();
                    const smallestCat = Object.keys(categories)
                        .filter(c => c !== cat)
                        .reduce((a, b) => categories[a].length < categories[b].length ? a : b);
                    categories[smallestCat].push(post);
                }
            });

            return categories;
        }

        function applyFilters() {
            const minWords = parseInt(document.getElementById('minWords').value) || 0;
            const minReadTime = parseInt(document.getElementById('minReadTime').value) || 0;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = allPosts.filter(post => 
                post.wordCount >= minWords && post.readTime >= minReadTime
            );

            switch(sortBy) {
                case 'date':
                    filtered.sort((a, b) => b.date - a.date);
                    break;
                case 'date-old':
                    filtered.sort((a, b) => a.date - b.date);
                    break;
                case 'length':
                    filtered.sort((a, b) => b.wordCount - a.wordCount);
                    break;
                case 'publication':
                    filtered.sort((a, b) => a.publicationName.localeCompare(b.publicationName));
                    break;
            }

            renderPosts(filtered);
        }

        function renderPosts(posts) {
            const content = document.getElementById('content');
            
            if (posts.length === 0) {
                content.innerHTML = '<div class="no-posts">No posts match your filters</div>';
                return;
            }

            const categories = categorize(posts);
            let html = '';

            for (const [category, categoryPosts] of Object.entries(categories)) {
                if (categoryPosts.length === 0) continue;

                html += `
                    <div class="category-section">
                        <div class="category-header">
                            <div class="category-title">${category}</div>
                            <div class="category-count">${categoryPosts.length} posts</div>
                        </div>
                        <div class="posts-grid">
                            ${categoryPosts.map(post => renderPost(post)).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function renderPost(post) {
            const timeAgo = getTimeAgo(post.date);
            const dateFormatted = post.date.toLocaleDateString('en-US', { 
                month: 'short', day: 'numeric', year: 'numeric' 
            });

            return `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-meta">
                            <div class="publication">${escapeHtml(post.publicationName)}</div>
                            <div class="author">by ${escapeHtml(post.author)}</div>
                        </div>
                    </div>
                    <h2 class="post-title">
                        <a href="${post.link}" target="_blank">${escapeHtml(post.title)}</a>
                    </h2>
                    <div class="post-excerpt">${escapeHtml(post.content)}...</div>
                    <div class="post-footer">
                        <div class="date-info">
                            <span>üìÖ ${dateFormatted}</span>
                            <span>üïê ${timeAgo}</span>
                        </div>
                        <div class="reading-stats">
                            <span class="word-count">${post.wordCount.toLocaleString()} words</span>
                            <span class="read-time">${post.readTime} min read</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval} ${unit}${interval !== 1 ? 's' : ''} ago`;
                }
            }
            return 'just now';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Load on startup
        loadFeeds();
    </script>
</body>
</html>